name: CI » Release

on:
  workflow_call:
    inputs:
      version:
        description: 'Version for the release (e.g., 1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag for the release (e.g., v1.2.3 or 1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      skip_validation:
        description: 'Skip build validation before release'
        required: false
        type: boolean
        default: false

jobs:
  # Optional validation when manually triggered
  validate:
    if: github.event_name == 'workflow_dispatch' && !inputs.skip_validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.version }}
      - uses: ./.github/actions/setup-tools

      - name: Validate Build
        run: |
          task build
        shell: bash

      - name: Run Lint
        run: |
          task lint:check
        shell: bash

  release:
    runs-on: ubuntu-latest
    needs: [validate]
    if: always() && (needs.validate.result == 'success' || needs.validate.result == 'skipped')
    permissions:
      contents: write
    steps:
      - name: Download version artifact (when called from workflow)
        if: github.event_name == 'workflow_call'
        uses: actions/download-artifact@v4
        with:
          name: version-output
          path: version-output

      - name: Extract version from artifact (when called from workflow)
        if: github.event_name == 'workflow_call'
        id: extract_version
        run: |
          if [ -f version-output/version.json ]; then
            VERSION=$(jq -r '.tag' version-output/version.json)
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Using version from artifact: $VERSION"
          else
            echo "ERROR: version.json not found in artifact"
            exit 1
          fi

      - name: Set version variable
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
            echo "Using version from input: ${{ inputs.version }}"
          else
            echo "version=${{ steps.extract_version.outputs.version }}" >> $GITHUB_OUTPUT
            echo "Using version from artifact: ${{ steps.extract_version.outputs.version }}"
          fi

      - name: Debug inputs
        run: |
          echo "event_name = ${{ github.event_name }}"
          echo "version = ${{ steps.version.outputs.version }}"
          echo "prerelease = ${{ inputs.prerelease }}"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.version.outputs.version }}
          fetch-depth: 0

      - name: Setup Toolchain
        uses: ./.github/actions/setup-tools

      - name: Read changelog
        id: changelog
        run: |
          if [ -f CHANGELOG.md ]; then
            echo "Using generated CHANGELOG.md from bumpalicious"
          else
            echo "CHANGELOG.md not found, will use tag as body"
            echo "Release ${{ steps.version.outputs.version }}" > CHANGELOG.md
          fi

      - name: Build release binaries
        run: |
          mkdir -p release-assets

          # Create Bash artifact (greeter.sh + cli.sh) if files exist
          if [ -f src/greeter.sh ] && [ -f src/cli.sh ]; then
            mkdir -p bash-artifact
            cp src/greeter.sh bash-artifact/
            cp src/cli.sh bash-artifact/
            cp README.md bash-artifact/ 2>/dev/null || echo "# Bash Greeter" > bash-artifact/README.md
            tar -czf release-assets/generic-template-bash-v${{ steps.version.outputs.version }}.tar.gz \
                -C bash-artifact .
            echo "✓ Created Bash artifact"
          else
            echo "⚠ Skipping Bash artifact (source files not found)"
          fi

          # Create PowerShell artifact (greeter.ps1 + cli.ps1) if files exist
          if [ -f src/greeter.ps1 ] && [ -f src/cli.ps1 ]; then
            mkdir -p powershell-artifact
            cp src/greeter.ps1 powershell-artifact/
            cp src/cli.ps1 powershell-artifact/
            cp README.md powershell-artifact/ 2>/dev/null || echo "# PowerShell Greeter" > powershell-artifact/README.md
            tar -czf release-assets/generic-template-powershell-v${{ steps.version.outputs.version }}.tar.gz \
                -C powershell-artifact .
            echo "✓ Created PowerShell artifact"
          else
            echo "⚠ Skipping PowerShell artifact (source files not found)"
          fi

          # Create full source tarball (excluding build artifacts and git)
          tar --exclude='.git' \
              --exclude='.cwai' \
              --exclude='.github/prompts' \
              --exclude='.uvx-install' \
              --exclude='.venv' \
              --exclude='node_modules' \
              --exclude='bash-artifact' \
              --exclude='powershell-artifact' \
              --exclude='release-assets' \
              -czf release-assets/generic-template-source-v${{ steps.version.outputs.version }}.tar.gz \
              .
          echo "✓ Created source tarball"

          echo ""
          echo "Release assets created:"
          ls -lah release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ inputs.prerelease }}
          files: release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
