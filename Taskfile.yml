version: '3'

vars:
  __TF_HEADER_LINE: '=============================================================='
  __TF_SEP: ' '
  __TF_MISE_E: 'mise trust; mise exec --'
  __TF_PATH:
    sh: |
      mise exec -- {{if eq OS "windows"
        }}pwsh -Command "\$Path = \$env:PATH; {{ .__TF_SEP
          }}\$Path.Replace('\', '/').Replace('C:/', '/c/').Replace('//', '/')"{{else
        }}echo $PATH{{end}}

tasks:
  # ==========================================================================
  # Environment Setup
  # ==========================================================================

  ensure:bash:
    desc: 'Exclude PowerShell scripts from task execution on non-Windows platforms'
    cmds:
      - cmd: |
          bash_path=$(pwsh -Command '(Get-Item (Get-Command bash).Path).FullName | Select-String system32 | Select-String windows' 2>/dev/null)
          if [ -n "$bash_path" ]; then
            echo "âš ï¸  Windows System32 bash detected - not supported due to path inconsistencies"
            echo "â„¹ï¸  On ðŸªŸ Windows, please, use ðŸŒ¿ Git Bash or ðŸ§ WSL instead"
            exit 1
          fi
          bash_path=$(pwsh -Command '(Get-Command bash).Path' 2>/dev/null)
          if [ -z "$bash_path" ]; then
            echo "âš ï¸  bash not found"
            echo "â„¹ï¸  On ðŸªŸ Windows, please, use ðŸŒ¿ Git Bash or ðŸ§ WSL instead"
            exit 1
          fi
        platforms: [windows]
      - cmd: |
          if ! command -v bash >/dev/null 2>&1; then
            echo "âš ï¸  bash not found"
            echo "â„¹ï¸  Please install bash to proceed"
            exit 1
          fi
        platforms: [linux, darwin]
    silent: true

  # ==========================================================================
  # Build Tasks
  # ==========================================================================

  print:env:
    env:
      PATH: '{{.__TF_PATH}}'
    cmds:
      - cmd: mise exec -- env | sort
        platforms: [darwin, linux]
      - cmd: |
          mise exec -- {{ .__TF_SEP
            }}pwsh -Command '$BashPath=(Get-Command bash).Path; {{ .__TF_SEP
            }}if ($BashPath) { & $BashPath -c 'env' } else { Get-ChildItem 'Env:' }' | sort
        platforms: [windows]
    deps:
      - task: ensure:bash
    desc: 'Print current build environment variables'

  build:
    desc: 'Build project (system: {{.CPP_BUILD_SYSTEM}}, type: {{.CPP_BUILD_TYPE}})'
    cmds:
      - task: print:env
      - cmd: echo "Building ..."

  # ============================================================================
  # Clean Tasks
  # ============================================================================

  clean:
    desc: 'Clean all build artifacts'
    cmds:
      - cmd: echo "Cleaning ..."

  # ============================================================================
  # Code Quality Tasks
  # ============================================================================

  format:
    desc: 'Format code and fix issues'
    cmds:
      - task: format:prettier
      - cmd: echo "âœ… Code format completed"

  format:prettier:
    cmds:
      - |
        {{.__TF_MISE_E}} npx prettier --write "./**/*.{json,toml,yaml,yml}"
    desc: 'Format code using Prettier'
    silent: true

  format:check:
    desc: 'Check code formatting without fixing'
    cmds:
      - task: format:check:prettier
      - cmd: echo "âœ… Code format check completed"

  format:check:prettier:
    cmds:
      - |
        {{.__TF_MISE_E}} npx prettier --check "./**/*.{json,toml,yaml,yml}"
    desc: 'Check code formatting using Prettier'
    silent: true

  lint:
    desc: 'Run linter and fix issues'
    cmds:
      - task: lint:eslint
      - task: lint:powershell
      - task: lint:shellcheck
      - cmd: echo "âœ… Linting completed"

  lint:staged:
    desc: 'Run linter on staged files and fix issues'
    cmds:
      - |
        mise exec -- npx -y lint-staged
    silent: true

  lint:eslint:
    cmds:
      - |
        {{.__TF_MISE_E}} npx eslint --fix "./**/*.{json,toml,yaml,yml}"
      - echo "- âœ… eslint lint completed"
    desc: 'Lint code using ESLint'
    silent: true

  lint:powershell:
    aliases: [lint:pwsh]
    cmds:
      - |
        {{.__TF_MISE_E}} pwsh -File .scripts/lint-powershell.ps1 -Fix {{if .STAGED}}-Staged{{end}}
      - echo "- âœ… pwsh lint completed"
    desc: 'Lint PowerShell scripts using PSScriptAnalyzer'
    silent: true

  lint:shellcheck:
    aliases: [lint:sh, lint:bash]
    cmds:
      - |
        {{.__TF_MISE_E}} bash .scripts/lint-shellcheck.sh --fix {{if .STAGED}}--staged{{end}}
      - echo "- âœ… bash lint completed"
    desc: 'Lint shell scripts using ShellCheck'
    silent: true

  lint:check:
    desc: 'Run linter without fixing'
    cmds:
      - task: lint:check:eslint
      - task: lint:check:powershell
      - task: lint:check:shellcheck
      - cmd: echo "âœ… Linting check completed"

  lint:check:eslint:
    cmds:
      - |
        {{.__TF_MISE_E}} npx eslint "./**/*.{toml,json,yaml,yml}"
      - echo "- âœ… eslint lint check completed"
    desc: 'Check code using ESLint'
    silent: true

  lint:check:powershell:
    aliases: [lint:check:pwsh]
    cmds:
      - |
        {{.__TF_MISE_E}} pwsh -File .scripts/lint-powershell.ps1 {{if .STAGED}}-Staged{{end}}
      - echo "- âœ… pwsh lint completed"
    desc: 'Check PowerShell scripts using PSScriptAnalyzer'
    silent: true

  lint:check:shellcheck:
    aliases: [lint:check:sh, lint:check:bash]
    cmds:
      - |
        {{.__TF_MISE_E}} bash .scripts/lint-shellcheck.sh {{if .STAGED}}--staged{{end}}
      - echo "- âœ… bash lint completed"
    desc: 'Check shell scripts using ShellCheck'
    silent: true

  duplicate-check:
    cmds:
      - |
        {{.__TF_MISE_E}} npm run duplicate-check
      - git add .jscpd/jscpd-badge.svg 2>/dev/null || true
    desc: 'Check for duplicate code using jscpd'

  # ============================================================================
  # Test Tasks
  # ============================================================================

  test:
    desc: 'Run tests (system: {{.CPP_BUILD_SYSTEM}})'
    cmds:
      - task: build
      - cmd: echo "Testing ..."

  test:gen-coverage:
    cmds:
      - cmd: echo "Generating coverage report ..."
    desc: 'Generate test coverage report'
    silent: true

  # ============================================================================
  # Development Tools
  # ============================================================================

  run:
    desc: 'Run application'
    deps:
      - task: build
    cmds:
      - cmd: echo "Running ..."

  debug:
    desc: 'Run application with debugger (gdb on Linux/macOS)'
    cmds:
      - task: Build
      - cmd: echo "Running (Debug mode)... "

  # ============================================================================
  # Documentation Tasks
  # ============================================================================

  docs:
    desc: 'Build documentation'
    cmds:
      - |
        {{.__TF_MISE_E}} uv run mkdocs build

  docs:serve:
    desc: 'Serve documentation locally with live reload'
    cmds:
      - |
        echo "ðŸ“š Starting documentation server..."
        echo "ðŸ“– Open http://127.0.0.1:8000 in your browser"
        {{.__TF_MISE_E}} uv run mkdocs serve

  docs:deploy:
    desc: 'Deploy documentation to GitHub Pages'
    cmds:
      - |
        {{.__TF_MISE_E}} uv run mkdocs gh-deploy --force

  # ============================================================================
  # Validation Tasks
  # ============================================================================

  validate:
    cmds:
      - task: format
      - task: clean
      - task: build
      - task: lint
      - task: run
      - task: clean
      - task: test
      - cmd: |
          echo ""
          echo "{{.__TF_HEADER_LINE}}"
          echo "âœ… Validation successful"
          echo "{{.__TF_HEADER_LINE}}"
          echo ""
    desc: 'Run CI pipeline for specific build system and compiler'
    silent: true

  # ============================================================================
  # Dependencies
  # ============================================================================

  deps:sync:
    cmds:
      - task: deps:sync:mise
      - task: deps:sync:npm
      - task: deps:sync:uv
    desc: 'Install all project dependencies'

  deps:sync:mise:
    cmds:
      - |
        echo "ðŸ“¦ Installing Mise dependencies..."
        mise trust && mise install --yes
        echo "âœ“ Mise environment ready"
    desc: 'Install Mise dependencies'

  deps:sync:npm:
    cmds:
      - |
        echo "ðŸ“¦ Installing NodeJs dependencies..."
        {{.__TF_MISE_E}} npm install
        echo "âœ“ NodeJs environment ready"
    desc: 'Install NodeJs dependencies'

  deps:sync:uv:
    cmds:
      - |
        echo "ðŸ“¦ Installing Python dependencies..."
        {{.__TF_MISE_E}} uv sync
        echo "âœ“ Python environment ready"
    desc: 'Install Python dependencies'

  deps:refresh:
    cmds:
      - task: deps:refresh:mise
      - task: deps:refresh:npm
      - task: deps:refresh:uv
    desc: 'Install all project dependencies'

  deps:refresh:mise:
    cmds:
      - |
        echo "ðŸ”„ Refreshing Mise packages..."
        mise upgrade
        echo "âœ“ Packages refreshed"
    desc: 'Refresh all Mise packages (update dependencies)'

  deps:refresh:npm:
    cmds:
      - |
        echo "ðŸ”„ Refreshing NodeJs packages..."
        {{.__TF_MISE_E}} npm outdated \
          && {{.__TF_MISE_E}} npm update \
          && {{.__TF_MISE_E}} npm audit fix
        echo "âœ“ Packages refreshed"
    desc: 'Refresh all NodeJs packages (update dependencies)'

  deps:refresh:uv:
    cmds:
      - |
        echo "ðŸ”„ Refreshing Python packages..."
        {{.__TF_MISE_E}} uv sync --upgrade
        echo "âœ“ Packages refreshed"
    desc: 'Refresh all Python packages (update dependencies)'
